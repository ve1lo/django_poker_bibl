{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="space-y-8 animate-in fade-in duration-500">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-4xl font-bold tracking-tight bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent">
                {{ tournament.name }}
            </h1>
            <p class="text-muted-foreground mt-1">{{ tournament.date|date:"F j, Y, P" }}</p>
        </div>
        <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-primary text-primary-foreground hover:bg-primary/80">
            {{ tournament.status }}
        </span>
    </div>

    <!-- Tournament Stats -->
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-xl border border-border/50 bg-card/50 p-6">
            <div class="text-sm font-medium text-muted-foreground">Buy-in</div>
            <div class="mt-2 text-3xl font-bold">${{ tournament.buy_in|default:"Free" }}</div>
        </div>
        <div class="rounded-xl border border-border/50 bg-card/50 p-6">
            <div class="text-sm font-medium text-muted-foreground">Starting Stack</div>
            <div class="mt-2 text-3xl font-bold">{{ tournament.stack|floatformat:0 }}</div>
        </div>
        <div class="rounded-xl border border-border/50 bg-card/50 p-6">
            <div class="text-sm font-medium text-muted-foreground">Players Registered</div>
            <div class="mt-2 text-3xl font-bold" id="total-players">{{ tournament.registrations.count }}</div>
        </div>
        <div class="rounded-xl border border-border/50 bg-card/50 p-6">
            <div class="text-sm font-medium text-muted-foreground">Type</div>
            <div class="mt-2 text-3xl font-bold">{{ tournament.type }}</div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="rounded-xl border border-border/50 bg-card/50 overflow-hidden">
        <div class="flex border-b border-border/50 bg-muted/20">
            <button data-tab="players" class="tab-button flex-1 px-6 py-4 text-sm font-medium transition-colors bg-background text-foreground shadow-sm">
                Players
            </button>
            <button data-tab="payouts" class="tab-button flex-1 px-6 py-4 text-sm font-medium transition-colors hover:bg-background/50 hover:text-foreground">
                Payouts
            </button>
            <button data-tab="seating" class="tab-button flex-1 px-6 py-4 text-sm font-medium transition-colors hover:bg-background/50 hover:text-foreground">
                Seating
                <span id="seating-update-indicator" class="ml-2 inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse hidden"></span>
            </button>
        </div>

        <!-- Players Tab -->
        <div id="tab-players" class="tab-content p-6">
            <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                    <thead class="[&_tr]:border-b [&_tr]:border-border/50">
                        <tr class="border-b transition-colors">
                            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Player</th>
                            <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground">Status</th>
                            {% if tournament.type == 'FREE' %}
                            <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground">Points</th>
                            <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground">Bounties</th>
                            {% else %}
                            <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground">Rebuys</th>
                            <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground">Addons</th>
                            {% endif %}
                            <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground">Place</th>
                            <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground">Payout</th>
                        </tr>
                    </thead>
                    <tbody class="[&_tr:last-child]:border-0" id="players-list">
                        {% for item in players_data %}
                        <tr class="border-b border-border/30 transition-colors hover:bg-muted/50">
                            <td class="p-4 align-middle">
                                <div class="font-medium">{{ item.registration.player.first_name|default:item.registration.player.username }}</div>
                                {% if item.registration.player.username %}
                                <div class="text-sm text-muted-foreground">@{{ item.registration.player.username }}</div>
                                {% endif %}
                            </td>
                            <td class="p-4 align-middle text-center">
                                {% if item.registration.status == 'REGISTERED' %}
                                <span class="inline-flex items-center rounded-full bg-green-500/10 px-2.5 py-0.5 text-xs font-semibold text-green-500">
                                    Active
                                </span>
                                {% else %}
                                <span class="inline-flex items-center rounded-full bg-gray-500/10 px-2.5 py-0.5 text-xs font-semibold text-gray-500">
                                    Eliminated
                                </span>
                                {% endif %}
                            </td>
                            {% if tournament.type == 'FREE' %}
                            <td class="p-4 align-middle text-center">
                                <span class="font-bold text-primary">{{ item.registration.points|default:0 }}</span>
                            </td>
                            <td class="p-4 align-middle text-center">
                                {% if item.registration.bounty_count > 0 %}
                                <span class="font-medium text-amber-400">üéØ {{ item.registration.bounty_count }}</span>
                                {% else %}
                                <span class="text-muted-foreground">-</span>
                                {% endif %}
                            </td>
                            {% else %}
                            <td class="p-4 align-middle text-center">
                                <span class="font-medium">{{ item.registration.rebuys|default:0 }}</span>
                            </td>
                            <td class="p-4 align-middle text-center">
                                <span class="font-medium">{{ item.registration.addons|default:0 }}</span>
                            </td>
                            {% endif %}
                            <td class="p-4 align-middle text-center">
                                {% if item.registration.place == 1 %}
                                <span class="inline-flex items-center rounded-full bg-yellow-500/10 px-2.5 py-0.5 text-xs font-semibold text-yellow-500">
                                    1st üèÜ
                                </span>
                                {% elif item.registration.place == 2 %}
                                <span class="inline-flex items-center rounded-full bg-gray-400/10 px-2.5 py-0.5 text-xs font-semibold text-gray-400">
                                    2nd ü•à
                                </span>
                                {% elif item.registration.place == 3 %}
                                <span class="inline-flex items-center rounded-full bg-orange-400/10 px-2.5 py-0.5 text-xs font-semibold text-orange-400">
                                    3rd ü•â
                                </span>
                                {% elif item.registration.place %}
                                <span class="font-medium">{{ item.registration.place }}</span>
                                {% else %}
                                <span class="text-muted-foreground">-</span>
                                {% endif %}
                            </td>
                            <td class="p-4 align-middle text-right">
                                {% if item.payout %}
                                <span class="font-bold text-green-500 text-lg">${{ item.payout|floatformat:0 }}</span>
                                {% else %}
                                <span class="text-muted-foreground">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="p-8 text-center text-muted-foreground">No players registered yet</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payouts Tab -->
        <div id="tab-payouts" class="tab-content hidden p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="rounded-lg bg-secondary/30 p-4">
                    <p class="text-sm text-muted-foreground mb-1">Total Prize Pool</p>
                    <p id="prize-pool-display" class="text-3xl font-bold">$0</p>
                </div>
                <div class="rounded-lg bg-secondary/30 p-4">
                    <p class="text-sm text-muted-foreground mb-1">Places Paid</p>
                    <p id="places-paid-display" class="text-3xl font-bold">0</p>
                </div>
            </div>

            <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                    <thead class="[&_tr]:border-b [&_tr]:border-border/50">
                        <tr class="border-b transition-colors">
                            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Place</th>
                            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Player</th>
                            <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground">Amount</th>
                        </tr>
                    </thead>
                    <tbody class="[&_tr:last-child]:border-0" id="payouts-list">
                        <!-- Will be populated by JavaScript -->
                        <tr>
                            <td colspan="3" class="p-8 text-center text-muted-foreground">Loading payouts...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Seating Tab -->
        <div id="tab-seating" class="tab-content hidden p-6">
            <div id="tables-container" class="grid gap-6 md:grid-cols-2 xl:grid-cols-3 transition-opacity duration-300">
                <!-- Tables will be rendered here by JavaScript -->
                <div class="col-span-full flex flex-col items-center justify-center py-12 text-center border border-dashed border-border/50 rounded-xl bg-card/30">
                    <div class="rounded-full bg-muted/50 p-4 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted-foreground">
                            <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="9" y1="21" x2="9" y2="9"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold">Loading seating...</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Tab Switching
    document.addEventListener('DOMContentLoaded', () => {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;

                // Update buttons
                tabButtons.forEach(btn => {
                    btn.classList.remove('bg-background', 'text-foreground', 'shadow-sm');
                    btn.classList.add('hover:bg-background/50', 'hover:text-foreground');
                });
                button.classList.add('bg-background', 'text-foreground', 'shadow-sm');
                button.classList.remove('hover:bg-background/50', 'hover:text-foreground');

                // Update content
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            });
        });

        // Load payouts data
        const tournamentId = {{ tournament.id }};
        loadPayouts(tournamentId);
        loadTables(tournamentId);

        // Auto-refresh tables every 5 seconds
        setInterval(() => {
            loadTables(tournamentId);
        }, 5000);

        // Auto-refresh payouts every 10 seconds
        setInterval(() => {
            loadPayouts(tournamentId);
        }, 10000);
    });

    // Load payouts
    async function loadPayouts(tournamentId) {
        try {
            const response = await fetch(`/api/tournament/${tournamentId}/payouts/`);
            const data = await response.json();

            const payoutsList = document.getElementById('payouts-list');

            if (data.payouts && data.payouts.length > 0) {
                // Update stats
                document.getElementById('prize-pool-display').textContent = `$${data.prize_pool.toLocaleString()}`;
                document.getElementById('places-paid-display').textContent = data.payouts.length;

                // Render payouts
                payoutsList.innerHTML = data.payouts.map(payout => `
                    <tr class="border-b border-border/30 transition-colors hover:bg-muted/50">
                        <td class="p-4 align-middle">
                            ${payout.place === 1 ? '<span class="inline-flex items-center rounded-full bg-yellow-500/10 px-2.5 py-0.5 text-xs font-semibold text-yellow-500">1st üèÜ</span>' :
                              payout.place === 2 ? '<span class="inline-flex items-center rounded-full bg-gray-400/10 px-2.5 py-0.5 text-xs font-semibold text-gray-400">2nd ü•à</span>' :
                              payout.place === 3 ? '<span class="inline-flex items-center rounded-full bg-orange-400/10 px-2.5 py-0.5 text-xs font-semibold text-orange-400">3rd ü•â</span>' :
                              `<span class="font-medium">${payout.place}</span>`}
                        </td>
                        <td class="p-4 align-middle">
                            ${payout.player_name ? `<span class="font-medium">${payout.player_name}</span>` : '<span class="text-muted-foreground">-</span>'}
                        </td>
                        <td class="p-4 align-middle text-right">
                            <span class="font-bold text-green-500 text-lg">$${payout.amount.toLocaleString()}</span>
                        </td>
                    </tr>
                `).join('');
            } else {
                payoutsList.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-muted-foreground">No payouts configured yet</td></tr>';
            }
        } catch (error) {
            console.error('Error loading payouts:', error);
        }
    }

    // Get seat positions for poker table visualization
    function getSeatPositions(maxSeats) {
        const positions = [];
        const centerX = 50;
        const centerY = 50;
        const radiusX = 48;
        const radiusY = 44;

        for (let i = 0; i < maxSeats; i++) {
            const angle = (i * 360 / maxSeats - 90) * Math.PI / 180;
            const x = centerX + radiusX * Math.cos(angle);
            const y = centerY + radiusY * Math.sin(angle);
            positions.push({ x, y });
        }

        return positions;
    }

    // Render poker table
    function renderPokerTable(tableNumber, seats, maxSeats) {
        const positions = getSeatPositions(maxSeats);
        let seatsHtml = '';

        for (let i = 1; i <= maxSeats; i++) {
            const player = seats.find(s => s.seat_number === i);
            const pos = positions[i - 1];

            const seatClass = player
                ? 'bg-primary/20 border-primary/40 text-primary'
                : 'bg-muted/30 border-border/30 text-muted-foreground';

            const playerName = player ? player.player_name : 'Empty';
            const nameClass = player ? 'font-semibold text-foreground' : 'text-muted-foreground italic text-xs';

            seatsHtml += `
                <div class="absolute seat-${i}" style="left: ${pos.x}%; top: ${pos.y}%; transform: translate(-50%, -50%);">
                    <div class="flex flex-col items-center gap-1">
                        <div class="w-12 h-12 rounded-full border-2 ${seatClass} flex items-center justify-center text-sm font-bold shadow-lg">
                            ${i}
                        </div>
                        <div class="text-center ${nameClass} text-xs max-w-[80px] truncate px-2 py-1 rounded bg-background/80 backdrop-blur-sm">
                            ${playerName}
                        </div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="w-full">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold">Table ${tableNumber}</h3>
                    <span class="text-xs text-muted-foreground">${seats.length} / ${maxSeats} Players</span>
                </div>
                <div class="relative mx-auto" style="width: 400px; height: 300px;">
                    <!-- Poker Table -->
                    <div class="absolute inset-0 rounded-full bg-gradient-to-br from-green-900 to-green-800 border-8 border-amber-900 shadow-2xl">
                        <div class="absolute inset-4 rounded-full border-4 border-amber-700/50"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-amber-200/40 font-bold text-2xl">TABLE</div>
                                <div class="text-amber-200/40 font-bold text-4xl">${tableNumber}</div>
                            </div>
                        </div>
                    </div>
                    <!-- Seats -->
                    ${seatsHtml}
                </div>
            </div>
        `;
    }

    // Store last tables data to prevent unnecessary updates
    let lastTablesData = null;

    // Load tables
    async function loadTables(tournamentId) {
        const indicator = document.getElementById('seating-update-indicator');

        try {
            // Show loading indicator
            if (indicator) indicator.classList.remove('hidden');

            const response = await fetch(`/api/tournament/${tournamentId}/tables/`);
            const data = await response.json();

            // Check if data has changed
            const currentDataString = JSON.stringify(data.tables);
            if (lastTablesData === currentDataString) {
                // Data hasn't changed, skip update to prevent flicker
                if (indicator) indicator.classList.add('hidden');
                return;
            }
            lastTablesData = currentDataString;

            const tablesContainer = document.getElementById('tables-container');

            if (data.tables && data.tables.length > 0) {
                // Add fade effect
                tablesContainer.style.opacity = '0.7';

                setTimeout(() => {
                    tablesContainer.innerHTML = data.tables.map(table => {
                        return `
                            <div class="flex flex-col items-center p-4">
                                ${renderPokerTable(table.number, table.seats, table.max_seats)}
                            </div>
                        `;
                    }).join('');

                    tablesContainer.style.opacity = '1';
                }, 150);
            } else {
                tablesContainer.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-12 text-center border border-dashed border-border/50 rounded-xl bg-card/30">
                        <div class="rounded-full bg-muted/50 p-4 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted-foreground">
                                <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="9" y1="21" x2="9" y2="9"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold">No Seating Assigned</h3>
                        <p class="text-muted-foreground max-w-sm mt-2">Tables have not been generated yet.</p>
                    </div>
                `;
            }

            // Hide indicator after a short delay
            setTimeout(() => {
                if (indicator) indicator.classList.add('hidden');
            }, 500);

        } catch (error) {
            console.error('Error loading tables:', error);
            if (indicator) indicator.classList.add('hidden');
        }
    }
</script>
{% endblock %}
